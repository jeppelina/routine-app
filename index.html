<!DOCTYPE html>
<html lang="sv">
<head>

  <!-- iOS / iPadOS Home Screen icon -->
<link rel="apple-touch-icon" sizes="180x180" href="icons/routine-icon-180.png">

<!-- PWA / Chrome -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#4e7d4e">

<!-- Optional favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="icons/routine-icon-32.png">

<!-- iOS standalone mode -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Otis, Loui & Teddys Rutiner!">

  <title>Otis, Loui & Teddys Att G√∂ra!</title>

  <style>
    :root {
      --bg: #f6f7f6;
      --card: #ffffff;
      --header: #6b8f71;
      --accent: #6b8f71;
      --accent-hover: #5a7a60;
      --done-bg: #e8f2eb;
      --task-bg: #f3f4f3;
      --task-done-bg: #e8f2eb;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
    }
    header {
      background: var(--header);
      color: white;
      padding: 1em;
      text-align: center;
    }
    #routine-toggle { margin-top: 0.5em; }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1em;
    }
    .header-title {
      display: flex;
      align-items: center;
      gap: 0.6em;
    }

    .app-icon {
      width: 34px;
      height: 34px;
      border-radius: 8px;   /* soft iOS feel */
      flex-shrink: 0;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }
    @media (max-width: 480px) {
      .app-icon {
        display: none;
      }
    }
    /* tighter buttons in header */
    #routine-toggle button {
      padding: 0.45em 0.7em;
      font-size: 15px;
    }

    /* make title not wrap too early */
    header h1 {
      margin: 0;
      font-size: 1.3em;
      white-space: nowrap;
    }

    #children-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      margin: 1em;
      gap: 1em;
    }
    .child-card {
      background: var(--card);
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      border-radius: 10px;
      padding: 1em;
      flex: 1 0 320px;
      max-width: 500px;
    }
    @media (max-width: 1024px) {
      .child-card {
        flex: 1 0 100%;
        max-width: 80%; 
      }
    
      #children-container {
        justify-content: center;
      }
    }
    .child-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75em;
      padding-bottom: 0.1em;
      margin-bottom: 0.1em;
    }
    .child-header h3 {
      margin: 0;
    }
    .stars {
      display: flex;
      align-items: center;
      gap: 0.35em;
      font-size: 1.1em;
      white-space: nowrap;
    }

    .task-list {
      display: flex;
      justify-content: space-between;
      gap: 0.75em;
      margin-top: 0.75em;
    }
    .task-column {
      flex: 1 0 0;
      padding: 0.5em;
      border: 1px solid #ddd;
      border-radius: 8px;
      min-height: 180px;
      background: var(--task-bg);
    }

    .task-column.done { 
      background: var(--task-done-bg);
    }

    .task-column h4 {
      margin: 0.25em 0 0.5em 0;
      text-align: center;
      font-size: 0.95em;
    }

    /* container inside each column that Sortable owns */
    .task-items {
      min-height: 130px;
      display: flex;
      flex-direction: column;
      gap: 0.4em;
    }

    .task {
      background: white;
      border: 1px solid #ddd;
      padding: 0.45em 0.5em;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5em;

      /* feels better on touch */
      cursor: grab;
    }

    .task:active { cursor: grabbing; }

    .task-text { flex: 1; }

    /* iOS: prevent long-press selection/callout */
    .task, .task * {
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    .task-delete {
      background: transparent;
      color: #666;
      border: 0;
      font-size: 20px;
      line-height: 1;
      padding: 0 6px;
      cursor: pointer;
    }
    .task-delete:hover { color: #111; }

    .add-task {
      margin-top: 0.75em;
      display: flex;
      gap: 0.5em;
    }
    .add-task input {
      flex: 1;
      padding: 0.55em 0.6em;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px; /* avoid iOS zoom */
    }
    
    .add-task {
      margin-top: 0.4em;
      gap: 0.4em;
    }
    
    .add-task input {
      padding: 0.35em 0.5em;
      font-size: 10px;
      line-height: 1.0;
    }
    
    .add-task button {
      padding: 0.15em 0.5em;
      font-size: 10px;
    }

    .reset-container {
      text-align: center;
      margin: 1em;
    }
    button {
      padding: 0.55em 0.8em;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: white;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover { background: var(--accent-hover); }

    /* Optional: highlight dragged item */
    .sortable-ghost {
      opacity: 0.35;
    }

    /* ===== Task menu modal (added) ===== */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .hidden { display: none; }

    .modal {
      width: min(320px, 90vw);
      background: var(--card);
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      text-align: left;
    }
    .modal-title {
      font-weight: 600;
      margin-bottom: 10px;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: space-between;
    }
    .modal-btn {
      flex: 1;
      padding: 0.55em 0.6em;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: white;
      cursor: pointer;
      font-size: 15px;
    }
    .modal-btn.secondary {
      background: #888;
    }
    .modal-btn.danger {
      background: #c0392b;
    }
    /* ================================ */
  </style>
</head>

<body>
  <header>
    <div class="header-row">
      <div class="header-title">
        <img src="icons/routine-icon-180.png" alt="" class="app-icon">
        <h1>Otis, Loui & Teddys Att G√∂ra!</h1>
      </div>
  
      <div id="routine-toggle">
        <button id="morningBtn">Morgon</button>
        <button id="eveningBtn">Kv√§ll</button>
        <button id="weekendBtn">Helg</button>
      </div>
    </div>
  </header>

  <div id="children-container"></div>

  <div class="reset-container">
    <button id="manualResetBtn">√Öterst√§ll</button>
  </div>

  <!-- ===== Task menu modal (added) ===== -->
  <div id="taskMenuOverlay" class="overlay hidden">
    <div class="modal">
      <div class="modal-title">V√§lj</div>
      <div class="modal-actions">
        <button id="taskMenuEditBtn" class="modal-btn">Redigera</button>
        <button id="taskMenuDeleteBtn" class="modal-btn danger">Ta bort</button>
        <button id="taskMenuCancelBtn" class="modal-btn secondary">Avbryt</button>
      </div>
    </div>
  </div>
  <!-- ================================ -->

  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <script>
    const STORAGE_KEY = 'routineData_v2';
    const defaultChildren = ['Teddy', 'Otis', 'Loui'];
    let data;

    const STARTER_TASKS = {
      Teddy: {
        morgon: ["Ta p√• kl√§der üëïüëñüß¶", "L√§gga pyjamas under kudden üõèÔ∏è", "√Ñt frukost ü•£ü•™", "Borsta t√§nderna ü¶∑ü™•",
         "L√§gg fram ytterkl√§der ü•æüß§", "Ta p√• ytterkl√§der ü¶∏üèº"],
        kv√§ll:  ["Pyjamas ü©≥üëï", "H√§ng upp morgondagens kl√§der p√• krok ü™ù", "L√§gg i tv√§ttkorgen üß∫ü´ß",
         "Borsta t√§nderna ü¶∑ü™•", "Kissa üöΩ", "üõåüìñ"],
        helg:   ["Tr√§na p√• n√•got i 30 minuter", "Hj√§lp till med en hush√•llssyssla", "St√§da ditt rum üßπ", "G√• ut och lek 1 timme"]
      },
      Otis: {
        morgon: ["Ta p√• kl√§der üëïüëñüß¶", "L√§gga pyjamas under kudden üõèÔ∏è", "√Ñt frukost ü•£ü•™", "Borsta t√§nderna ü¶∑ü™•",
         "L√§gg fram ytterkl√§der ü•æüß§", "Ta p√• ytterkl√§der ü¶∏üèº"],
        kv√§ll:  ["L√§sa l√§xan 15 minuter üìñ", "Packa skolv√§skan üéí (gympa, l√§xan, utflykt)", "Pyjamas ü©≥üëï", "H√§ng upp morgondagens kl√§der p√• krok ü™ù",
         "L√§gg i tv√§ttkorgen üß∫ü´ß", "Borsta t√§nderna ü¶∑ü™•"],
        helg:   ["Tr√§na p√• n√•got i 30 minuter", "Hj√§lp till med en hush√•llssyssla", "St√§da ditt rum üßπ", "G√• ut och lek 1 timme"]
      },
      Loui: {
        morgon: ["Ta p√• kl√§der üëïüëñüß¶", "L√§gga pyjamas under kudden üõèÔ∏è", "√Ñt frukost ü•£ü•™", "Borsta t√§nderna ü¶∑ü™•",
         "L√§gg fram ytterkl√§der ü•æüß§", "Ta p√• ytterkl√§der ü¶∏üèº"],
        kv√§ll:  ["L√§sa l√§xan 15 minuter üìñ", "Packa skolv√§skan üéí (gympa, l√§xan, utflykt)", "Pyjamas ü©≥üëï", "H√§ng upp morgondagens kl√§der p√• krok ü™ù",
         "L√§gg i tv√§ttkorgen üß∫ü´ß", "Borsta t√§nderna ü¶∑ü™•"],
        helg:   ["Tr√§na p√• n√•got i 30 minuter", "Hj√§lp till med en hush√•llssyssla", "St√§da ditt rum üßπ", "G√• ut och lek 1 timme"]
      }
    };

    // ===== THEMES (added) =====
    const THEMES = {
      morgon: {
        '--bg': '#f3f7f2',
        '--card': '#ffffff',
        '--header': '#4e7d4e',
        '--accent': '#4e7d4e',
        '--accent-hover': '#3f653f',
        '--task-bg': '#e6efe6',
        '--task-done-bg': '#cfe2cf'
      },
      kv√§ll: {
        '--bg': '#f3f1f7',
        '--card': '#ffffff',
        '--header': '#6b5ca5',
        '--accent': '#6b5ca5',
        '--accent-hover': '#574a86',
        '--task-bg': '#ebe7f2',
        '--task-done-bg': '#d8d1ea'
      },
      helg: {
        '--bg': '#fff8f0',          // warm cream
        '--card': '#ffffff',
        '--header': '#ff9f1c',      // orange
        '--accent': '#2ec4b6',      // turquoise
        '--accent-hover': '#1fa89c',
        '--task-bg': '#eaf6ff',     // sky blue
        '--task-done-bg': '#f1ffe7' // light green
}
    };

    function applyThemeForRoutine() {
      const theme = THEMES[data.routine] || THEMES.morgon;
      const root = document.documentElement;
      Object.entries(theme).forEach(([k, v]) => root.style.setProperty(k, v));
    }
    // ==========================

    // ===== Task menu state + handlers (added) =====
    let taskMenuState = null;

    function openTaskMenu(childIndex, taskId) {
      taskMenuState = { childIndex, taskId };
      document.getElementById('taskMenuOverlay').classList.remove('hidden');
    }

    function closeTaskMenu() {
      taskMenuState = null;
      document.getElementById('taskMenuOverlay').classList.add('hidden');
    }

    // Wire modal buttons immediately (overlay exists before script runs)
    const overlayEl = document.getElementById('taskMenuOverlay');
    document.getElementById('taskMenuCancelBtn').addEventListener('click', closeTaskMenu);
    overlayEl.addEventListener('click', (e) => {
      if (e.target === overlayEl) closeTaskMenu(); // tap outside
    });

    document.getElementById('taskMenuDeleteBtn').addEventListener('click', () => {
      if (!taskMenuState) return;

      const ok = window.confirm('Ta bort?');
      if (!ok) return;

      const { childIndex, taskId } = taskMenuState;
      const arr = data.children[childIndex].tasks[data.routine];
      const idx = arr.findIndex(t => t.id === taskId);
      if (idx >= 0) arr.splice(idx, 1);

      saveData();
      closeTaskMenu();
      render();
    });

    document.getElementById('taskMenuEditBtn').addEventListener('click', () => {
      if (!taskMenuState) return;

      const { childIndex, taskId } = taskMenuState;
      const arr = data.children[childIndex].tasks[data.routine];
      const task = arr.find(t => t.id === taskId);
      if (!task) { closeTaskMenu(); return; }

      const newText = window.prompt('Redigera uppgift:', task.text);
      if (newText === null) return; // cancelled
      const trimmed = newText.trim();
      if (!trimmed) return; // ignore empty

      task.text = trimmed;
      saveData();
      closeTaskMenu();
      render();
    });
    // =============================================

    function makeId() {
      // stable-enough unique id for local use
      return 't_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 8);
    }

    function initData() {
  const stored = localStorage.getItem(STORAGE_KEY);

  // ---- Existing data: load + migrate ----
  if (stored) {
    data = JSON.parse(stored);

    data.children.forEach(ch => {
      ['morgon', 'kv√§ll', 'helg'].forEach(r => {
        if (!ch.tasks[r]) ch.tasks[r] = [];
        ch.tasks[r].forEach(t => {
          if (!t.id) t.id = makeId();
        });
      });
    });

    saveData();
    return;
  }

  // ---- First run: create + seed starter tasks ----
  data = {
    routine: 'morgon',
    children: defaultChildren.map(name => ({
      name,
      tasks: { morgon: [], kv√§ll: [], helg: [] }
    }))
  };

  // Seed starter tasks
  data.children.forEach(child => {
    const preset = STARTER_TASKS[child.name];
    if (!preset) return;

    ['morgon', 'kv√§ll', 'helg'].forEach(r => {
      (preset[r] || []).forEach(text => {
        child.tasks[r].push({
          id: makeId(),
          text,
          completed: false
        });
      });
    });
  });

  saveData();
}

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function doneCount(child) {
      return child.tasks[data.routine].filter(t => t.completed).length;
    }

    function render() {
      const container = document.getElementById('children-container');
      container.innerHTML = '';

      data.children.forEach((child, childIndex) => {
        const card = document.createElement('div');
        card.className = 'child-card';

        // header
        const header = document.createElement('div');
        header.className = 'child-header';

        const nameElem = document.createElement('h3');
        nameElem.textContent = child.name;

        const starElem = document.createElement('div');
        starElem.className = 'stars';
        starElem.innerHTML = `‚≠ê <span>${doneCount(child)}</span>`;

        header.appendChild(nameElem);
        header.appendChild(starElem);
        card.appendChild(header);

        // columns
        const listContainer = document.createElement('div');
        listContainer.className = 'task-list';

        const todoCol = document.createElement('div');
        todoCol.className = 'task-column todo';
        todoCol.innerHTML = `<h4>Att g√∂ra</h4>`;
        const todoItems = document.createElement('div');
        todoItems.className = 'task-items';
        todoItems.id = `todo-items-${childIndex}`;
        todoCol.appendChild(todoItems);

        const doneCol = document.createElement('div');
        doneCol.className = 'task-column done';
        doneCol.innerHTML = `<h4>Klar</h4>`;
        const doneItems = document.createElement('div');
        doneItems.className = 'task-items';
        doneItems.id = `done-items-${childIndex}`;
        doneCol.appendChild(doneItems);

        // tasks
        child.tasks[data.routine].forEach(task => {
          const taskElem = document.createElement('div');
          taskElem.className = 'task';
          taskElem.dataset.taskId = task.id;

          const textSpan = document.createElement('span');
          textSpan.className = 'task-text';
          textSpan.textContent = task.text;

          const delBtn = document.createElement('button');
          delBtn.className = 'task-delete';
          delBtn.type = 'button';
          delBtn.textContent = '√ó';

          // open menu (instead of immediate delete)
          delBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openTaskMenu(childIndex, task.id);
          });

          taskElem.appendChild(textSpan);
          taskElem.appendChild(delBtn);

          if (task.completed) doneItems.appendChild(taskElem);
          else todoItems.appendChild(taskElem);
        });

        listContainer.appendChild(todoCol);
        listContainer.appendChild(doneCol);
        card.appendChild(listContainer);

        // add task
        const addTaskContainer = document.createElement('div');
        addTaskContainer.className = 'add-task';

        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Ny uppgift';

        const addButton = document.createElement('button');
        addButton.textContent = 'L√§gg till';

        addButton.addEventListener('click', () => {
          const text = input.value.trim();
          if (!text) return;

          data.children[childIndex].tasks[data.routine].push({
            id: makeId(),
            text,
            completed: false
          });

          saveData();
          render();
        });

        addTaskContainer.appendChild(input);
        addTaskContainer.appendChild(addButton);
        card.appendChild(addTaskContainer);

        container.appendChild(card);
      });

      attachSortables();
    }

    function syncChildFromDOM(childIndex) {
      const todoEl = document.getElementById(`todo-items-${childIndex}`);
      const doneEl = document.getElementById(`done-items-${childIndex}`);
      if (!todoEl || !doneEl) return;

      const orderTodo = Array.from(todoEl.querySelectorAll('.task')).map(el => el.dataset.taskId);
      const orderDone = Array.from(doneEl.querySelectorAll('.task')).map(el => el.dataset.taskId);

      const current = data.children[childIndex].tasks[data.routine];
      const byId = new Map(current.map(t => [t.id, t]));

      const newArr = [];

      for (const id of orderTodo) {
        const t = byId.get(id);
        if (t) { t.completed = false; newArr.push(t); }
      }
      for (const id of orderDone) {
        const t = byId.get(id);
        if (t) { t.completed = true; newArr.push(t); }
      }

      data.children[childIndex].tasks[data.routine] = newArr;
      saveData();
    }

    function attachSortables() {
      data.children.forEach((child, childIndex) => {
        const todoEl = document.getElementById(`todo-items-${childIndex}`);
        const doneEl = document.getElementById(`done-items-${childIndex}`);
        if (!todoEl || !doneEl) return;

        const groupName = `child-${childIndex}-${data.routine}`; // keep each child separate

        const common = {
          group: groupName,
          animation: 150,
          forceFallback: true,
          fallbackOnBody: true,

          // critical: don't start drag from delete button
          filter: '.task-delete',
          preventOnFilter: true,

          // keep the page from selecting text / doing weird callouts
          delayOnTouchOnly: true,
          delay: 0,
          touchStartThreshold: 0,

          onEnd: () => {
            syncChildFromDOM(childIndex);
            render(); // rerender so stars update and indices are consistent
          }
        };

        // Destroy old instances if re-rendered
        if (todoEl._sortable) todoEl._sortable.destroy();
        if (doneEl._sortable) doneEl._sortable.destroy();

        todoEl._sortable = Sortable.create(todoEl, common);
        doneEl._sortable = Sortable.create(doneEl, common);
      });
    }

    // Routine toggles
    document.getElementById('morningBtn').addEventListener('click', () => {
      data.routine = 'morgon';
      saveData();
      applyThemeForRoutine();
      render();
    });
    document.getElementById('eveningBtn').addEventListener('click', () => {
      data.routine = 'kv√§ll';
      saveData();
      applyThemeForRoutine();
      render();
    });
    document.getElementById('weekendBtn').addEventListener('click', () => {
      data.routine = 'helg';
      saveData();
      applyThemeForRoutine();
      render();
    });

    // Reset
    document.getElementById('manualResetBtn').addEventListener('click', () => {
      if (!confirm('Vill du √•terst√§lla rutiner och stj√§rnor?')) return;

      data.children.forEach(child => {
        child.tasks[data.routine].forEach(t => t.completed = false);
      });

      saveData();
      render();
    });

    initData();
    applyThemeForRoutine();
    render();
  </script>
</body>
</html>
